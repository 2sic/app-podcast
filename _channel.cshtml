<script type="text/javascript" src="@App.Path/assets/jquery.jplayer.min.js"></script>
@using Dynlist = System.Collections.Generic.IEnumerable<dynamic>;
@{
    var episodes = Content.Parents("Episode") as Dynlist;
    /* Counter which is brought for the identification of the individual episodes  */
    var episodeNumber = 0;
}
<link rel="stylesheet" data-enableoptimizations="true" href="@App.Path/assets/style.css" />

<div class="container sc-element">
    @Edit.Toolbar(Content)
    <div class="row">
        <!-- Left column with image, episode counter and channel description -->
        <div class="col-12 col-md-4">
            <div class="card border-0">
                <img src="@Content.Image?w=200&h=200&mode=crop">
                <div class="card-body p-0">
                    <p class="card-text">
                        <!-- TODO: add translation -->
                        <p class="text-muted">
                            @episodes.Count() Episoden
                        </p> 
                        <hr>
                        <div class="pc-channel-description-desktop">
                            @Html.Raw(Content.Description)
                        </div>
                    </p>
                </div>
            </div>
        </div>
        <!-- Right column with the rest of the channel information and the episode listing -->
        <div class="col-12 col-md-8"> 
            <div class="card border-0 mb-4">
                <!-- Channel Information -->
                <div class="card-body p-0">
                    <h3 class="card-title pc-channel-title">
                        @Content.Title
                    </h3>
                    <h5 class="card-subtitle mb-3 pc-owner-name">
                        @Content.Owner[0].FullName
                    </h5>
                    <div class="pc-channel-description-mobile">
                        @Html.Raw(Content.Description)
                    </div>
                    <div class="pc-channel-category-rss">
                        <p class="card-text text-muted mb-0">
                            @Content.Category[0].Name
                        </p>
                        <a href="@Link.To(parameters: "rss/true/?standalone=true")" 
                           class="badge badge-pill badge-secondary"
                           target="_blank">
                           <i class="fas fa-rss align-self-center" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>
            </div>
            <!-- Listing of episodes -->
            <ul class="list-group"  @Edit.TagToolbar(actions: "new", contentType: "Episode", prefill: new {
                    Channels = new string[] { Content.EntityGuid.ToString() },
                    Author = new string[] { (Content.Owner as Dynlist).First().EntityGuid.ToString() },
                    Date = DateTime.Now.ToString("MM.dd.yyyy")
                })>
                @foreach(var episode in episodes.OrderByDescending(e => e.Date)) {
                    episodeNumber++;
                    <!-- Episode information -->
                    <li class="list-group-item border-right-0 border-left-0 p-0 pb-3 pt-3" @Edit.TagToolbar(episode, actions: "edit")>
                        <p class="text-muted pc-episode-date">
                            @episode.Date.ToString("dd MMM yyyy")
                        </p>
                        <h5 class="m-0">
                            @episode.Title
                        </h5>
                        <div class="pc-episode-description">
                            @Html.Raw(episode.Description)
                        </div>
                        <!-- jPlayer audio player -->
                        <div id="jquery_jplayer_@episodeNumber" class="jp-jplayer episode-audio-@episodeNumber" 
                             data-episode-audio="@episode.Audio"
                             data-episode-number="@episodeNumber">
                        </div>
                        <div id="jp_container_@episodeNumber" class="jp-audio jp-audio-@episodeNumber">
                            <div class="jp-interface jp-interface-@episodeNumber bg-primary">
                                <div class="jp-controls-holder">
                                    <div class="jp-controls">
                                        <button class="jp-play jp-play-@episodeNumber" type="button">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </div>
                                    <div class="jp-progress jp-progress-@episodeNumber">
                                        <div class="jp-seek-bar">
                                            <div class="jp-play-bar jp-play-bar-@episodeNumber" data-episode-number="@episodeNumber">
                                                <div class="pc-drag-handler pc-drag-handler-@episodeNumber"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="jp-time-control jp-time-control-@episodeNumber">
                                    <div class="pc-gap">&nbsp;</div>
                                    <div class="jp-time-labels">
                                        <div class="jp-current-time">&nbsp;</div>
                                        <div class="jp-duration">&nbsp;</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <span class="episode-duration episode-duration-@episodeNumber text-muted">
                            @episode.Duration
                        </span>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>
<script>
    $(document).ready(function(){
        $('.jp-jplayer').each(function() {
            var episodeNumber = $(this).data('episode-number');

            $(this).jPlayer({
                ready: function () {
                    $(this).jPlayer('setMedia', {
                        mp3: $(this).data('episode-audio'),
                    });
                },
                play: function () {
                    // exchange play with pause icon
                    $('.jp-play-' + episodeNumber + ' svg').attr('data-icon', 'pause');
                    $('.jp-play-' + episodeNumber + ' svg').removeClass('fa-play').addClass('fa-pause');

                    showAudioPlayerElements(episodeNumber);

                    // pause other instances of player when current one plays
                    $(this).jPlayer('pauseOthers');
                },
                timeupdate: function(event) {
			        $('.pc-drag-handler-' + episodeNumber).css('left', event.jPlayer.status.currentPercentAbsolute + '%');
                },
                pause: function () {
                    // exchange pause with play icon
                    $('.jp-play-' + episodeNumber + ' svg').attr('data-icon', 'play');
                    $('.jp-play-' + episodeNumber + ' svg').removeClass('fa-pause').addClass('fa-play');
                },
                ended: function () {
                    // reset the drag handler
                    $('.pc-drag-handler-' + episodeNumber).css('left', '0');

                    hideAudioPlayerElements(episodeNumber);
                },
                cssSelectorAncestor: '#jp_container_' + episodeNumber,
                swfPath: '/assets',
                supplied: 'mp3',
                useStateClassSkin: true,
                remainingDuration: true,
                toggleDuration: true,
                preload:  'none',
            })
        });

        /* Format the episode duration */
        $('.episode-duration').each(function() {
            var hr = ~~($(this).context.innerHTML / 60);
            var min = ~~($(this).context.innerHTML % 60);
            var formatedDuration = hr + ' hr ' + min + ' min';

            $(this).context.innerHTML = formatedDuration;
        });

        /* Show audio player elements */
        var showAudioPlayerElements = function(episodeNumber) {
            $('.jp-audio-' + episodeNumber).css('width', '100%');
            $('.jp-interface-' + episodeNumber).css('width', '25%');
            $('.jp-interface-' + episodeNumber).css('padding', '10px 6px 0 0');
            $('.jp-progress-' + episodeNumber).css('display', 'block');
            $('.jp-time-control-' + episodeNumber).css('display', 'flex');
            $('.episode-duration-' + episodeNumber).css('display', 'none');
        }

        /* Hide audio player elements */
        var hideAudioPlayerElements = function(episodeNumber) {
            $('.jp-audio-' + episodeNumber).css('width', '6%');
            $('.jp-interface-' + episodeNumber).css('width', '100%');
            $('.jp-interface-' + episodeNumber).css('padding', '10px 6px 10px 0');
            $('.jp-progress-' + episodeNumber).css('display', 'none');
            $('.jp-time-control-' + episodeNumber).css('display', 'none');
            $('.episode-duration-' + episodeNumber).css('display', 'inline');
        }


         /* Draghandler event listeners */
        var timeDrag = false; // Drag status
        var episodeNumber = 0;
        $('.jp-play-bar').mousedown(function(e) {
            timeDrag = true;
            episodeNumber = $(this).data('episode-number');
            updateBar(e.pageX);
        });
        $(document).mouseup(function (e) {
            if (timeDrag) {
                timeDrag = false;
                updateBar(e.pageX);
            }
        });
        $(document).mousemove(function (e) {
            if (timeDrag) {
                updateBar(e.pageX);
            }
        });

        /* Update Progress Bar control */
        var updateBar = function (x) {
            var progress = $('.jp-progress-' + episodeNumber);
            var maxduration = $('#jquery_jplayer_' + episodeNumber).data('jPlayer').status.duration; // audio duration
            var position = x - progress.offset().left; // Click pos
            var percentage = 100 * position / progress.width();

            // Check within range
            if (percentage > 100) {
                percentage = 100;
            }
            if (percentage < 0) {
                percentage = 0;
            }

            $('#jquery_jplayer_' + episodeNumber).jPlayer('playHead', percentage);

            // Update progress bar and audio currenttime
            $('.pc-drag-handler-' + episodeNumber).css('left', percentage + '%');
            $('.jp-play-bar-' + episodeNumber).css('width', percentage + '%');
            $('#jquery_jplayer_' + episodeNumber).jPlayer.currentTime = maxduration * percentage / 100;
        };
    });
</script>